# –ë–æ–Ω—É—Å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ - PostgreSQL

## üìã –û–ø–∏—Å
–ü–æ–≤–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –±–æ–Ω—É—Å—ñ–≤ –¥–ª—è –∫–ª—ñ—î–Ω—Ç—ñ–≤ –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é —Ç—Ä–∏–≥–µ—Ä—ñ–≤ PostgreSQL.

## üöÄ –®–≤–∏–¥–∫–µ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è

### 1. –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–∏—Ö —Ç—Ä–∏–≥–µ—Ä—ñ–≤
```bash
# –í –æ—Å–Ω–æ–≤–Ω—ñ–π –ø–∞–ø—Ü—ñ –ø—Ä–æ–µ–∫—Ç—É
docker exec -i avocado_postgres psql -U avocado_user -d avocado_db < postgresDB/bonus_triggers.sql
```

### 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è
```sql
-- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
SELECT * FROM system_settings WHERE key LIKE 'bonus%';

-- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç—Ä–∏–≥–µ—Ä–∏
SELECT event_object_table, trigger_name, action_timing, event_manipulation 
FROM information_schema.triggers 
WHERE trigger_name = 'trigger_process_bonus_operations';
```

## üîß –ö–ª—é—á–æ–≤—ñ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ

### –í–∞–ª—é—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç
- **clients.bonus**: –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –∫–æ–ø—ñ–π–∫–∞—Ö √ó 100 (–¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç—ñ)
- **transaction_bonus.amount**: –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –∫–æ–ø—ñ–π–∫–∞—Ö
- **–†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏**: –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –≤ –≥—Ä–∏–≤–Ω—è—Ö, –ø–æ—Ç—ñ–º –∫–æ–Ω–≤–µ—Ä—Ç—É—é—Ç—å—Å—è

### –£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –æ–ø–∏—Å–∏
- –í—Å—ñ –æ–ø–∏—Å–∏ –±–æ–Ω—É—Å–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é
- "–ù–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è X% –±–æ–Ω—É—Å—ñ–≤ –∑–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é #ID"
- "–û–ø–ª–∞—Ç–∞ –±–æ–Ω—É—Å–∞–º–∏ –∑–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é #ID"

### –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É—é—á–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π
- NULL-–±–µ–∑–ø–µ—á–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –≤—Å—ñ—Ö –∑–Ω–∞—á–µ–Ω—å

## üìä –ö–æ—Ä–∏—Å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó

### –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç—Ä–∏–≥–µ—Ä–∞–º–∏
```sql
-- –£–≤—ñ–º–∫–Ω—É—Ç–∏ –±–æ–Ω—É—Å–Ω—É —Å–∏—Å—Ç–µ–º—É
SELECT manage_bonus_triggers(true);

-- –í–∏–º–∫–Ω—É—Ç–∏ –±–æ–Ω—É—Å–Ω—É —Å–∏—Å—Ç–µ–º—É  
SELECT manage_bonus_triggers(false);
```

### –ü–µ—Ä–µ—Å—á–µ—Ç –±–æ–Ω—É—Å—ñ–≤
```sql
-- –ü–æ–≤–Ω–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç –≤—Å—ñ—Ö –±–æ–Ω—É—Å—ñ–≤
SELECT * FROM recalculate_all_bonuses_with_trigger();
```

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏
```sql
-- –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –¥–∞—Ç—É –ø–æ—á–∞—Ç–∫—É
SELECT set_setting('bonus_system_start_date', '2025-09-01');

-- –£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ —Å–∏—Å—Ç–µ–º—É
SELECT set_setting('bonus_system_enabled', 'true');
```

## üõ†Ô∏è –°–∫—Ä–∏–ø—Ç–∏ –¥–ª—è —Ä–æ–±–æ—Ç–∏

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–ª—ñ—î–Ω—Ç–∞
```bash
cd script
python check_client_bonus.py <client_id>
```

### –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π
```bash
cd script/sync
python sync_poster_receipts.py today
```

## üìà –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
```sql
SELECT 
    operation_type,
    COUNT(*) as operations_count,
    SUM(CASE WHEN amount > 0 THEN amount ELSE 0 END) / 100.0 as total_earned_grn,
    SUM(CASE WHEN amount < 0 THEN ABS(amount) ELSE 0 END) / 100.0 as total_spent_grn
FROM transaction_bonus 
GROUP BY operation_type;
```

### –¢–æ–ø –∫–ª—ñ—î–Ω—Ç—ñ–≤ –∑–∞ –±–æ–Ω—É—Å–∞–º–∏
```sql
SELECT 
    c.client_id,
    c.name,
    c.phone,
    c.bonus / 100.0 as bonus_balance_grn
FROM clients c 
WHERE c.bonus > 0 
ORDER BY c.bonus DESC 
LIMIT 10;
```

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤—ñ –Ω–æ—Ç–∞—Ç–∫–∏

1. **–†–µ–∑–µ—Ä–≤–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è**: –û–±–æ–≤'—è–∑–∫–æ–≤–æ —Å—Ç–≤–æ—Ä—ñ—Ç—å backup –ø–µ—Ä–µ–¥ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è–º
2. **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è**: –°–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ñ–π –±–∞–∑—ñ
3. **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥**: –í—ñ–¥—Å—Ç–µ–∂—É–π—Ç–µ –ª–æ–≥–∏ –ø—ñ—Å–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è
4. **–í–∞–ª—é—Ç–∞**: –í—Å—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ –≤—Ä–∞—Ö–æ–≤—É—é—Ç—å —Ñ–æ—Ä–º–∞—Ç –∫–æ–ø—ñ–π–∫–∏ √ó 100

## üîç –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ–º–∏–ª–æ–∫
```sql
-- –û—Å—Ç–∞–Ω–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –ª–æ–≥–∞—Ö
SELECT * FROM pg_stat_activity WHERE query LIKE '%bonus%';
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ
```bash
python script/check_client_bonus.py <client_id>
```

–§–∞–π–ª –±—É–¥–µ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ä–æ–∑–±—ñ–∂–Ω–æ—Å—Ç—ñ –º—ñ–∂ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∏–º —Ç–∞ —Ñ–∞–∫—Ç–∏—á–Ω–∏–º –±–∞–ª–∞–Ω—Å–æ–º.

## üìû –ü—ñ–¥—Ç—Ä–∏–º–∫–∞

–í—Å—ñ —Ñ–∞–π–ª–∏ –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –≤ –ø–∞–ø—Ü—ñ `postgresDB/`:
- `bonus_triggers.sql` - –æ—Å–Ω–æ–≤–Ω–∏–π —Ñ–∞–π–ª –∑ —Ç—Ä–∏–≥–µ—Ä–∞–º–∏
- `fix_bonus_function_v5_ukr.sql` - –æ—Å—Ç–∞–Ω–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

–î–ª—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç—É –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ `bonus_triggers.sql`.
