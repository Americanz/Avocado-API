# –ê–Ω–∞–ª—ñ–∑ –ø–∞–ø–∫–∏ `telegram_bot`

## üìã –ó–∞–≥–∞–ª—å–Ω–∏–π –æ–ø–∏—Å

–ü–∞–ø–∫–∞ `telegram_bot` –º—ñ—Å—Ç–∏—Ç—å –ø–æ–≤–Ω–æ—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π Telegram –±–æ—Ç –¥–ª—è —Å–∏—Å—Ç–µ–º–∏ Avocado API –∑ —Å—É—á–∞—Å–Ω–æ—é –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–æ—é –Ω–∞ –±–∞–∑—ñ **aiogram 3**. –¶–µ –æ—Å–Ω–æ–≤–Ω–∏–π –±–æ—Ç –¥–ª—è –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏, —è–∫–∏–π –ø—Ä–∞—Ü—é—î –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ –∑ –º–æ–¥—É–ª–µ–º –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó (`src/core/models/auth/telegram/`).

## üèóÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### **–°–∏–ª—å–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏:**

1. **–ú–æ–¥—É–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** - —á—ñ—Ç–∫–µ —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç–µ–π
2. **–°–∏—Å—Ç–µ–º–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó** - –≤–ª–∞—Å–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è –º–µ–Ω—é
3. **–î–µ–∫–æ—Ä–∞—Ç–æ—Ä–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥** - –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Ö–µ–Ω–¥–ª–µ—Ä—ñ–≤ –∫–Ω–æ–ø–æ–∫
4. **Middleware —Å–∏—Å—Ç–µ–º–∞** - –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö
5. **FSM (Finite State Machine)** - –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö –¥—ñ–∞–ª–æ–≥—ñ–≤
6. **–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥** - JSON –¥–ª—è —Ç–µ–∫—Å—Ç—ñ–≤ —Ç–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä

### üìÅ **–î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```
telegram_bot/
‚îú‚îÄ‚îÄ üöÄ bot.py                 # –ì–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫—É
‚îú‚îÄ‚îÄ ‚öôÔ∏è config.py              # –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞
‚îú‚îÄ‚îÄ üß™ test_bonus.py          # –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É
‚îÇ
‚îú‚îÄ‚îÄ üìä data/                  # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ –¥–∞–Ω—ñ
‚îÇ   ‚îú‚îÄ‚îÄ bot_texts.json        # –¢–µ–∫—Å—Ç–∏ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É (—É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é)
‚îÇ   ‚îú‚îÄ‚îÄ bot_texts.py          # –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ —Ç–µ–∫—Å—Ç–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ keyboards.json        # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä —Ç–∞ –∫–Ω–æ–ø–æ–∫
‚îÇ   ‚îú‚îÄ‚îÄ keyboards.py          # –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–ª–∞–≤—ñ–∞—Ç—É—Ä
‚îÇ   ‚îî‚îÄ‚îÄ nav_menus.json        # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω–∏—Ö –º–µ–Ω—é
‚îÇ
‚îú‚îÄ‚îÄ üéØ handlers/              # –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
‚îÇ   ‚îú‚îÄ‚îÄ user.py              # –ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—ñ –∫–æ–º–∞–Ω–¥–∏ (/start, —Ç–æ—â–æ)
‚îÇ   ‚îú‚îÄ‚îÄ admin_nav.py         # –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è
‚îÇ   ‚îú‚îÄ‚îÄ user_nav.py          # –ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è
‚îÇ   ‚îî‚îÄ‚îÄ procedures/          # –°–∫–ª–∞–¥–Ω—ñ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏
‚îÇ       ‚îî‚îÄ‚îÄ register.py      # –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫–Ω–æ–ø–æ–∫ —Ç–∞ —Ö–µ–Ω–¥–ª–µ—Ä—ñ–≤
‚îÇ
‚îú‚îÄ‚îÄ ‚å®Ô∏è keyboards/             # –î–∏–Ω–∞–º—ñ—á–Ω—ñ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
‚îÇ   ‚îú‚îÄ‚îÄ dynamic.py           # –î–∏–Ω–∞–º—ñ—á–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–Ω–æ–ø–æ–∫
‚îÇ   ‚îî‚îÄ‚îÄ main.py             # –û—Å–Ω–æ–≤–Ω—ñ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
‚îÇ
‚îú‚îÄ‚îÄ üîß middlewares/          # –ü—Ä–æ–º—ñ–∂–Ω–µ –ü–ó
‚îÇ   ‚îî‚îÄ‚îÄ db.py               # –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Supabase
‚îÇ
‚îú‚îÄ‚îÄ üß≠ navigation/           # –°–∏—Å—Ç–µ–º–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
‚îÇ   ‚îú‚îÄ‚îÄ menu_manager.py     # –ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ–Ω—é —Ç–∞ –ø–µ—Ä–µ—Ö–æ–¥—ñ–≤
‚îÇ   ‚îú‚îÄ‚îÄ decorators.py       # –î–µ–∫–æ—Ä–∞—Ç–æ—Ä–∏ –¥–ª—è —Ö–µ–Ω–¥–ª–µ—Ä—ñ–≤
‚îÇ   ‚îú‚îÄ‚îÄ state.py            # –°—Ç–∞–Ω –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
‚îÇ   ‚îú‚îÄ‚îÄ README.md           # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
‚îÇ   ‚îî‚îÄ‚îÄ MIGRATION.md        # –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –º—ñ–≥—Ä–∞—Ü—ñ—ó
‚îÇ
‚îú‚îÄ‚îÄ üõ†Ô∏è services/            # –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ supabase/           # –°–µ—Ä–≤—ñ—Å–∏ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ Supabase
‚îÇ
‚îú‚îÄ‚îÄ üì± states/              # FSM —Å—Ç–∞–Ω–∏
‚îÇ   ‚îî‚îÄ‚îÄ phone_state.py      # –°—Ç–∞–Ω –≤–≤–µ–¥–µ–Ω–Ω—è —Ç–µ–ª–µ—Ñ–æ–Ω—É
‚îÇ
‚îî‚îÄ‚îÄ üóëÔ∏è to_delete/           # –ó–∞—Å—Ç–∞—Ä—ñ–ª—ñ —Ñ–∞–π–ª–∏
    ‚îî‚îÄ‚îÄ procedures.py       # –°—Ç–∞—Ä—ñ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏ (–≤–∏–¥–∞–ª–∏—Ç–∏)
```

## üéØ **–û—Å–Ω–æ–≤–Ω–∏–π —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª**

### –ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—ñ —Ñ—É–Ω–∫—Ü—ñ—ó:

- ‚úÖ **–ü–µ—Ä–µ–≥–ª—è–¥ –±–∞–ª–∞–Ω—Å—É –±–æ–Ω—É—Å—ñ–≤** - –∫—Ä–∞—Å–∏–≤–∏–π –≤–∏–≤—ñ–¥ –∑ –µ–º–æ–¥–∑—ñ
- ‚úÖ **–Ü—Å—Ç–æ—Ä—ñ—è –æ–ø–µ—Ä–∞—Ü—ñ–π** - –¥–µ—Ç–∞–ª—å–Ω–∞ —ñ—Å—Ç–æ—Ä—ñ—è –±–æ–Ω—É—Å–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π
- ‚úÖ **–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —á–µ—Ä–µ–∑ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É** - FSM –¥–ª—è –∑–±–æ—Ä—É –¥–∞–Ω–∏—Ö
- ‚úÖ **–ù–∞–≤—ñ–≥–∞—Ü—ñ—è —á–µ—Ä–µ–∑ –º–µ–Ω—é** - —ñ–Ω—Ç—É—ó—Ç–∏–≤–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∫–Ω–æ–ø–æ–∫

### –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó:

- ‚úÖ **–ü–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞** - –¥–æ—Å—Ç—É–ø –∑–∞ ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- ‚úÖ **–ö–µ—Ä—É–≤–∞–Ω–Ω—è –±–æ–Ω—É—Å–∞–º–∏** - –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è/—Å–ø–∏—Å–∞–Ω–Ω—è
- ‚úÖ **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤** - –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º–∏
- ‚úÖ **–ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏** - –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è

## üîß **–¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ**

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó:

- **aiogram 3** - —Å—É—á–∞—Å–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –¥–ª—è Telegram –±–æ—Ç—ñ–≤
- **Supabase** - –±–∞–∑–∞ –¥–∞–Ω–∏—Ö —Ç–∞ backend as a service
- **FSM (Finite State Machine)** - –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Å—Ç–∞–Ω–∞–º–∏ –¥—ñ–∞–ª–æ–≥—ñ–≤
- **JSON –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è** - –≥–Ω—É—á–∫–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—ñ–≤ —ñ –∫–Ω–æ–ø–æ–∫

### –ö–ª—é—á–æ–≤—ñ —Ñ–∞–π–ª–∏:

#### `bot.py` - –ì–æ–ª–æ–≤–Ω–∏–π –∑–∞–ø—É—Å–∫

```python
# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–∏—Å—Ç–µ–º–∏ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
menu_manager = MenuManager()

# –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Ö–µ–Ω–¥–ª–µ—Ä—ñ–≤ –∫–Ω–æ–ø–æ–∫
for handler_name, handler_func in get_button_handlers().items():
    menu_manager.register_button_handler(handler_name, handler_func)

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è aiogram
bot = Bot(token=settings.TELEGRAM_BOT_TOKEN)
dp = Dispatcher(storage=MemoryStorage())
```

#### `config.py` - –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

```python
class Settings:
    TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "")
    SUPABASE_API_URL = os.getenv("SUPABASE_API_URL", "")
    SUPABASE_API_KEY = os.getenv("SUPABASE_API_KEY", "")
```

#### `data/bot_texts.json` - –¢–µ–∫—Å—Ç–∏ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É

```json
{
  "welcome": "–í—ñ—Ç–∞—é, {username}! –í–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ —É –±–æ–Ω—É—Å–Ω—ñ–π —Å–∏—Å—Ç–µ–º—ñ.",
  "balance_beauty": "‚ú® –í–∞—à –±–∞–ª–∞–Ω—Å: <b>{balance}</b> –±–æ–Ω—É—Å—ñ–≤! ‚ú®",
  "history_beauty": "üóÇ <b>–Ü—Å—Ç–æ—Ä—ñ—è –≤–∞—à–∏—Ö –±–æ–Ω—É—Å—ñ–≤:</b>\n{items}"
}
```

#### `data/keyboards.json` - –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∫–Ω–æ–ø–æ–∫

```json
{
  "main": [
    {
      "text": "–ú—ñ–π –±–∞–ª–∞–Ω—Å",
      "handler": "show_balance"
    },
    {
      "text": "–Ü—Å—Ç–æ—Ä—ñ—è –±–æ–Ω—É—Å—ñ–≤",
      "handler": "show_history"
    }
  ]
}
```

## üöÄ **–°–∏—Å—Ç–µ–º–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó**

### –ü–µ—Ä–µ–≤–∞–≥–∏ –≤–ª–∞—Å–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó:

- **–î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ñ —Ö–µ–Ω–¥–ª–µ—Ä–∏** - –ø—Ä–æ—Å—Ç—ñ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∏ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
- **–Ü—Å—Ç–æ—Ä—ñ—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø–µ—Ä–µ—Ö–æ–¥—ñ–≤
- **"–¢–∏—Ö—ñ" –ø–µ—Ä–µ—Ö–æ–¥–∏** - –º—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–∏ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
- **–¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è** - —î–¥–∏–Ω–µ –º—ñ—Å—Ü–µ –¥–ª—è –º–µ–Ω—é

### –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:

```python
@button_handler("show_balance")
async def handle_show_balance(callback: CallbackQuery, **kwargs):
    # –õ–æ–≥—ñ–∫–∞ –ø–æ–∫–∞–∑—É –±–∞–ª–∞–Ω—Å—É
    pass
```

## üìä **–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ Supabase**

### –¢–∞–±–ª–∏—Ü—ñ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö:

- `bot_users` - –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –±–æ—Ç–∞
- `bonuses` - –±–æ–Ω—É—Å–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó
- –Ü–Ω—à—ñ —Ç–∞–±–ª–∏—Ü—ñ –¥–ª—è –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏

### Middleware –¥–ª—è –ë–î:

```python
class DBSessionMiddleware:
    async def __call__(self, handler, event, data):
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Supabase
        return await handler(event, data)
```

## üé® **–ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–π –¥–æ—Å–≤—ñ–¥**

### –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ UX:

- **–ï–º–æ–¥–∑—ñ —Ç–∞ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è** - –∫—Ä–∞—Å–∏–≤–∏–π –≤–∏–≥–ª—è–¥ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
- **–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –ª–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è** - –ø–æ–≤–Ω—ñ—Å—Ç—é —É–∫—Ä–∞—ó–Ω–æ–º–æ–≤–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- **–†–µ–∞–≥—É–≤–∞–Ω–Ω—è –Ω–∞ –ø–æ–º–∏–ª–∫–∏** - –∑—Ä–æ–∑—É–º—ñ–ª—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏
- **–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó** - –æ–∫—Ä–µ–º–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∞–¥–º—ñ–Ω—ñ–≤

## üîÑ **–í—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –º–æ–¥—É–ª—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó**

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞  | `telegram_bot/`        | `src/core/models/auth/telegram/` |
| --------------- | ---------------------- | -------------------------------- |
| **–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è** | –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ –±–æ–Ω—É—Å—ñ–≤  | –ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤      |
| **–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞**  | aiogram 3              | python-telegram-bot              |
| **–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö**  | Supabase               | PostgreSQL —á–µ—Ä–µ–∑ SQLAlchemy      |
| **–Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å**   | –ü–æ–≤–Ω–æ—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π UI | –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –¥–ª—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó   |
| **–õ–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è** | –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞             | –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞                       |
| **–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞** | –ú–æ–¥—É–ª—å–Ω–∞ –∑ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—î—é  | –ü—Ä–æ—Å—Ç–∏–π webhook/polling          |

## üöß **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ—ó —Ä–æ–∑—Ä–æ–±–∫–∏**

### 1. **–ö–æ—Ä–æ—Ç–∫–æ—Å—Ç—Ä–æ–∫–æ–≤—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è**

#### –í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞—Å—Ç–∞—Ä—ñ–ª—ñ —Ñ–∞–π–ª–∏:

```bash
rm -rf telegram_bot/to_delete/
```

#### –î–æ–¥–∞—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ –º–æ–¥—É–ª—ñ:

- `telegram_bot/utils/` - –¥–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
- `telegram_bot/exceptions/` - –≤–ª–∞—Å–Ω—ñ –≤–∏–Ω—è—Ç–∫–∏
- `telegram_bot/validators/` - –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö

#### –ü–æ–∫—Ä–∞—â–∏—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é:

```python
# telegram_bot/config.py
class Settings:
    # –î–æ–¥–∞—Ç–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é
    TELEGRAM_BOT_TOKEN: str = Field(..., env="TELEGRAM_BOT_TOKEN")
    SUPABASE_API_URL: str = Field(..., env="SUPABASE_API_URL")

    # –î–æ–¥–∞—Ç–∏ –Ω–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
    DEBUG_MODE: bool = Field(False, env="DEBUG_MODE")
    WEBHOOK_URL: str = Field(None, env="WEBHOOK_URL")
```

### 2. **–°–µ—Ä–µ–¥–Ω—å–æ—Å—Ç—Ä–æ–∫–æ–≤—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è**

#### –†–æ–∑—à–∏—Ä–∏—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª:

- **–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è** - push-–Ω–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –¥–ª—è –≤–∞–∂–ª–∏–≤–∏—Ö –ø–æ–¥—ñ–π
- **–ó–≤—ñ—Ç–∏** - –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è PDF –∑–≤—ñ—Ç—ñ–≤ –¥–ª—è –∞–¥–º—ñ–Ω—ñ–≤
- **–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ API** - —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ –æ—Å–Ω–æ–≤–Ω–∏–º Avocado API
- **–ë–µ–∑–ø–µ–∫–∞** - rate limiting —Ç–∞ –∞–Ω—Ç–∏—Å–ø–∞–º

#### –ü–æ–∫—Ä–∞—â–∏—Ç–∏ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É:

```python
# telegram_bot/services/notification_service.py
class NotificationService:
    async def send_bonus_notification(self, user_id: int, amount: int):
        # –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è –±–æ–Ω—É—Å—ñ–≤
        pass

# telegram_bot/services/report_service.py
class ReportService:
    async def generate_user_report(self, user_id: int) -> bytes:
        # –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è PDF –∑–≤—ñ—Ç—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        pass
```

### 3. **–î–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è**

#### –ú–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è:

- **Webhook –∑–∞–º—ñ—Å—Ç—å polling** - –¥–ª—è –≤–∏—Å–æ–∫–æ–Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö —Å–∏—Å—Ç–µ–º
- **Redis –¥–ª—è –∫–µ—à—É–≤–∞–Ω–Ω—è** - —à–≤–∏–¥–∫–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –¥–∞–Ω–∏—Ö
- **Distributed system** - —Ä–æ–∑–ø–æ–¥—ñ–ª –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
- **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥** - Prometheus + Grafana

#### –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ –µ–∫–æ—Å–∏—Å—Ç–µ–º–æ—é:

```python
# –û–±'—î–¥–Ω–∞–Ω–Ω—è –∑ –æ—Å–Ω–æ–≤–Ω–∏–º API
from src.core.models.auth.telegram import telegram_auth_controller

class UnifiedBotService:
    def __init__(self):
        self.auth_controller = telegram_auth_controller
        self.bonus_service = BonusService()

    async def handle_user_login(self, telegram_id: int):
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤—Ö—ñ–¥ —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–∏–π API
        auth_result = await self.auth_controller.login_by_telegram_id(telegram_id)
        if auth_result["status"] == "success":
            # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ –±–æ–Ω—É—Å–Ω—É —Å–∏—Å—Ç–µ–º—É
            return await self.bonus_service.get_user_bonuses(telegram_id)
```

## üìù **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É –ø—ñ—Å–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó**

```
telegram_bot/
‚îú‚îÄ‚îÄ üöÄ bot.py                     # –ì–æ–ª–æ–≤–Ω–∏–π –∑–∞–ø—É—Å–∫
‚îú‚îÄ‚îÄ ‚öôÔ∏è config.py                  # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é
‚îú‚îÄ‚îÄ üß™ tests/                     # –¢–µ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ test_handlers.py
‚îÇ   ‚îú‚îÄ‚îÄ test_navigation.py
‚îÇ   ‚îî‚îÄ‚îÄ conftest.py
‚îÇ
‚îú‚îÄ‚îÄ üìä data/                      # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ –¥–∞–Ω—ñ
‚îÇ   ‚îú‚îÄ‚îÄ bot_texts.json
‚îÇ   ‚îú‚îÄ‚îÄ keyboards.json
‚îÇ   ‚îî‚îÄ‚îÄ nav_menus.json
‚îÇ
‚îú‚îÄ‚îÄ üéØ handlers/                  # –û–±—Ä–æ–±–Ω–∏–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ user.py
‚îÇ   ‚îú‚îÄ‚îÄ admin.py
‚îÇ   ‚îî‚îÄ‚îÄ procedures/
‚îÇ
‚îú‚îÄ‚îÄ üõ†Ô∏è services/                  # –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ bonus_service.py
‚îÇ   ‚îú‚îÄ‚îÄ user_service.py
‚îÇ   ‚îú‚îÄ‚îÄ notification_service.py
‚îÇ   ‚îî‚îÄ‚îÄ supabase/
‚îÇ
‚îú‚îÄ‚îÄ üîß middlewares/               # Middleware
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ db.py
‚îÇ   ‚îú‚îÄ‚îÄ auth.py
‚îÇ   ‚îî‚îÄ‚îÄ rate_limit.py
‚îÇ
‚îú‚îÄ‚îÄ üß≠ navigation/                # –ù–∞–≤—ñ–≥–∞—Ü—ñ—è
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ menu_manager.py
‚îÇ   ‚îú‚îÄ‚îÄ decorators.py
‚îÇ   ‚îî‚îÄ‚îÄ state.py
‚îÇ
‚îú‚îÄ‚îÄ üì± states/                    # FSM —Å—Ç–∞–Ω–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ phone_state.py
‚îÇ   ‚îî‚îÄ‚îÄ admin_states.py
‚îÇ
‚îú‚îÄ‚îÄ ‚å®Ô∏è keyboards/                 # –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ dynamic.py
‚îÇ   ‚îî‚îÄ‚îÄ static.py
‚îÇ
‚îú‚îÄ‚îÄ üõ°Ô∏è utils/                     # –£—Ç–∏–ª—ñ—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ formatters.py
‚îÇ   ‚îú‚îÄ‚îÄ validators.py
‚îÇ   ‚îî‚îÄ‚îÄ helpers.py
‚îÇ
‚îî‚îÄ‚îÄ üö® exceptions/                # –í–∏–Ω—è—Ç–∫–∏
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ bot_exceptions.py
    ‚îî‚îÄ‚îÄ api_exceptions.py
```

## üéâ **–í–∏—Å–Ω–æ–≤–æ–∫**

–ü–∞–ø–∫–∞ `telegram_bot` –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—î —Å–æ–±–æ—é –¥–æ–±—Ä–µ —Å–ø—Ä–æ–µ–∫—Ç–æ–≤–∞–Ω–∏–π, –º–æ–¥—É–ª—å–Ω–∏–π Telegram –±–æ—Ç –∑ —Å—É—á–∞—Å–Ω–æ—é –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–æ—é. –û—Å–Ω–æ–≤–Ω—ñ –ø–µ—Ä–µ–≤–∞–≥–∏:

- ‚úÖ **–ì–æ—Ç–æ–≤–∏–π –¥–æ –ø—Ä–æ–¥–∞–∫—à–Ω—É** - —Å—Ç–∞–±—ñ–ª—å–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –Ω–∞ aiogram 3
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω–∏–π** - –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ª–µ–≥–∫–æ–≥–æ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É
- ‚úÖ **–ó—Ä—É—á–Ω–∏–π** - —ñ–Ω—Ç—É—ó—Ç–∏–≤–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- ‚úÖ **–ì–Ω—É—á–∫–∏–π** - JSON –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –¥–ª—è —à–≤–∏–¥–∫–∏—Ö –∑–º—ñ–Ω

–†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –ø—Ä–æ–¥–æ–≤–∂—É–≤–∞—Ç–∏ —Ä–æ–∑–≤–∏—Ç–æ–∫ —Å–∞–º–µ —Ü—å–æ–≥–æ –±–æ—Ç–∞ —è–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É –¥–ª—è –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏ —Å–∏—Å—Ç–µ–º–∏ Avocado —á–µ—Ä–µ–∑ Telegram.
